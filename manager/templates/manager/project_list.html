{% extends 'manager/base.html' %}
{% block content %}
<div class="container py-4">

  <!-- Header with AJAX Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Projects</h2>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addProjectModal">
      + Add Project
    </button>
  </div>

  <!-- Filter Dropdown -->
  {% comment %} <form method="get" class="mb-3 d-flex align-items-center">
    <select name="status" class="form-select me-2" style="width: 200px;" onchange="this.form.submit()">
      <option value="">All</option>
      <option value="ongoing" {% if filter_status == 'ongoing' %}selected{% endif %}>Ongoing</option>
      <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Completed</option>
    </select>
  </form>
   {% endcomment %}
<!-- Search Bar -->
  <form method="get" class="mb-3 d-flex align-items-center gap-2 flex-wrap">
  <label class="me-2">Filter:</label>
  <input type="text" name="search" value="{{ search_query }}" class="form-control" style="width: 250px;" placeholder="Search by project name...">
  <select name="status" class="form-select" style="width: 200px;" onchange="this.form.submit()">
    <option value="">All</option>
    <option value="ongoing" {% if filter_status == 'ongoing' %}selected{% endif %}>Ongoing</option>
    <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Completed</option>
  </select>

  <button type="submit" class="btn btn-secondary">Search</button>
</form>

  <!-- Project Cards -->
  <div class="row">
    {% for project in projects %}
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">{{ project.name }}</h5>
          <p class="card-text">{{ project.description|truncatechars:100 }}</p>
          <a href="{% url 'project_detail' project.pk %}" class="btn btn-outline-primary">Details</a>
          <button type="button" class="btn btn-outline-warning btn-sm"onclick="openEditModal({{ project.pk }})">Edit</button>
          <a href="{% url 'delete_project' project.pk %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this project?')">Delete</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- ============================ -->
<!-- AJAX Modal to Add Project -->
<!-- ============================ -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="ajax-project-form" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">Project Name</label>
          <input type="text" name="name" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control" required></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" class="form-control" required>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Add Project</button>
      </div>
    </form>
  </div>
</div>

<!-- ============================ -->
<!-- AJAX Script for Modal Form -->
<!-- ============================ -->
<script>
  document.getElementById('ajax-project-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'ajax_add_project' %}", {
      method: 'POST',
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('✅ Project added successfully!');
          setTimeout(() => location.reload(), 2000);
          {% comment %} location.reload(); {% endcomment %}
        } else {
          alert('❌ Error: ' + JSON.stringify(data.errors));
        }
      });
  });
</script>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="ajax-edit-project-form" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        {% csrf_token %}
        <input type="hidden" id="edit-project-id">

        <div class="mb-3">
          <label class="form-label">Project Name</label>
          <input type="text" name="name" id="edit-project-name" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" id="edit-project-description" class="form-control" required></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" id="edit-project-start" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" id="edit-project-end" class="form-control" required>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openEditModal(projectId) {
    fetch(`/project/ajax/edit/${projectId}/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('edit-project-id').value = projectId;
        document.getElementById('edit-project-name').value = data.name;
        document.getElementById('edit-project-description').value = data.description;
        document.getElementById('edit-project-start').value = data.start_date;
        document.getElementById('edit-project-end').value = data.end_date;

        const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
        modal.show();
      })
      .catch(err => {
        alert("❌ Failed to load project data.");
        console.error(err);
      });
  }

  document.getElementById('ajax-edit-project-form').addEventListener('submit', function(e) {
    e.preventDefault();

    const projectId = document.getElementById('edit-project-id').value;
    const formData = new FormData(this);

    fetch(`/project/ajax/edit/${projectId}/`, {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("✅ Project updated!");
        location.reload();
      } else {
        alert("❌ Error: " + JSON.stringify(data.errors));
      }
    })
    .catch(err => {
      alert("❌ Failed to update.");
      console.error(err);
    });
  });
</script>
{% endblock %}